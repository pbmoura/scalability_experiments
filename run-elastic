#!/bin/bash
#units contention coherency s1 x1 num_processes num_workers trace_file log_file
if [ "a$9" == "a" ]; then
  log_file=`echo "$1_$2_$3_$4_$5_$6_$7_$8"`
else
  log_file=`echo $9`
fi
echo "log_file: " $log_file
mkdir -p logs
mkdir -p results
echo "starting workers"
#RESERVATION=`preserve -# $7 -t 15:00|head -n 1 |cut -f 3 -d ' '|sed 's/://'`
#echo $RESERVATION
prun -np $7 ./worker-elastic.sh $2 $3 $6 $log_file &
num=0
while [ $num != $7 ];
do
  sleep 5
  NODES=`preserve -llist | grep $USER | cut -f 9 | sed 's/ /,/g'`
  num=`echo $NODES |tr -s ',' '\n' | grep -c 'node'`
done
echo $NODES
#echo $1 $2 $3 $4 $6 `date` >> logs/$8.worker-`hostname`
#echo "#" $1 $2 $3 $4 $6 `date` >> results/$8.worker-`hostname`
#prun -np $7 -reserve $RESERVATION ./worker-elastic.sh $2 $3 $6 $log_file &
sleep 5

echo "starting pool manager"
echo $1 $2 $3 $4 $6 $7 `date` >> logs/$log_file.pm
echo $1 $2 $3 $4 $6 $7 `date` >> results/$log_file.pm
prun -np 1 poolmanager.sh $7 $NODES $log_file &
poolmanager=""
while ((`echo $poolmanager|wc -c` <= 1))
do
  sleep 5
  echo "searching pool manager node"
  if [ "$7" == "1" ]; then
    poolmanager=`preserve -llist | grep $USER | awk '{if ($7 == "r") print $0}' |grep -v $NODES | cut -f 9`
  else
    poolmanager=`preserve -llist | grep $USER | awk '{if ($7 == "r" && $8 == "1") print $0}' | cut -f 9`
  fi
done
echo "it is " $poolmanager

echo "starting load balancer"
echo $1 $2 $3 $4 $6 $7 `date` >> logs/$log_file.lb
echo $1 $2 $3 $4 $6 $7 `date` >> results/$log_file.lb
prun -np 1 ./loadbalancer-elastic.sh $poolmanager $2 $3 $4 $5 $log_file &
loadbalancer=""
while ((`echo $loadbalancer|wc -c` <= 1))
do
  sleep 5
  echo "searching load balacner node"
  if [ "$7" == "1" ]; then
    loadbalancer=`preserve -llist | grep $USER | awk '{if ($7 == "r") print $0}' | grep -v $poolmanager | grep -v $NODES | cut -f 9`
  else    
    loadbalancer=`preserve -llist | grep $USER | awk '{if ($7 == "r" && $8 == "1") print $0}' | grep -v $poolmanager | cut -f 9`
  fi
done
echo "it is " $loadbalancer
sleep 5
echo $1 $2 $3 $4 $6 $7 `date` >> logs/$log_file.play
echo "#" $1 $2 $3 $4 $6 $7 `date` >> results/$log_file.play
echo "starting trace"
prun -np 1 ./trace-player.sh $1 $loadbalancer $8 $log_file
echo "killing all"
killall prun > /dev/null
#preserve -c $RESERVATION

